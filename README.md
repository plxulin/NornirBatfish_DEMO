# NornirBatfish_DEMO

Topics:

1. Environment
2. Nornir demo
3. Batfish demo

## ENV

### IDE VScode

download link: <https://code.visualstudio.com/download>

Recommanded Plugins:

- Remote SSH
- Remote WSL
- Jupyter
- markdownlint
- Git Graph
- Material Theme (Icons)

### Libraries

this project is used for nornir&batfish presentation demo, following libraries are used in this demo:

1. nornir
2. nornir_napalm
3. nornir_netmiko
4. nornir_utils
5. nornir_jinjia2
6. pybatfish

Others:

1. ansible
2. jupyter
3. flask
4. webexteamssdk

To install those libraries, pls use following command:

```bash
pip install -r requirements.txt
```

## Nornir Demo

### 1. AnsibleVsNornir

Generate configuration data for hosts, no need for real ssh connection, result are saved in AnsibleVsNornir/output. Compare the exec speed of them.

Ansible

```bash
time ansible-playbook -i inventory/ansible/inventory-100.yaml ansible_test.yml
```

Nornir

```bash
time python nornir_test.py 100
```

### 2. Tutorial/Tutorial-PluginBasic.ipynb

**Attention**: for the use of *ipynb , you needs jupyter extention installed

1. pip install jupyter
2. VScode jupyter Extention

This file is for go through the basic function of (netmiko/napalm/jinjia2).
Useful links for get start:

- [napalm](https://napalm.readthedocs.io/en/latest/tutorials/index.html)
- [netmiko](https://ktbyers.github.io/netmiko/#tutorialsexamplesgetting-started)
- [jinjia2](https://ttl255.com/jinja2-tutorial-part-1-introduction-and-variable-substitution/)

### 3. Tutorial/Tutorial-Nornir.ipynb

This file is for go through the basic use of Nornir.
Reference: <https://nornir.readthedocs.io/en/latest/tutorial/index.html>

### 4. Demo-PnetLab

This File will do the read ssh connections to the PNET LAB(network simulater). Directory Components:

- ./Demo-PnetLab.ipynb (main program)
- ./config.yaml (Nornir Config YAML file)
- ./inventory (Nornir inventory info)
- ./mytasks (Tasks defined by myself)
- ./templates (jinjia2 template for config generation )
- ./configs (save the config generated by jinjia2)
- ./output (Devices show info output)

### 5. Extention: Nornir + Flask + WebexTeam BOT

This is a simple demo script about how to combine all these intersting things together. REST API is a good stuff.

In order to play with this demo, following requirements is needed.

- request a webex bot and get the token
- use ngrok to make your application got the public ip proxy (webhook)

```bash
# I have a server with pubic ip, so i use reverse ssh instead of ngrok
autossh -NR ali:8010:localhost:8080 root@ali &
```

## Batfish

In order to use batfish, you needs to set up batfish server (docker). and install python library: pybatfish on client side

```bash
# Server
docker pull batfish/allinone
docker run -v batfish-data:/data -p 8888:8888 -p 9997:9997 -p 9996:9996 batfish/allinon

# Client
pip install pybatfish
```

<https://www.batfish.org/assets/cheat-sheet.pdf>

### Demo-batfish.ipynb

This shows the basic use of batfish. In fact you can use the build-in tutorial in the docker.

### Demo Use Scenerio

Related Directories:

- ./Scenerio[0-2].py
- ./batfish_snpshot
- Nornir ralted: inventory config.yaml mytask etc

#### Scenerio 0, basic analysis

```bash
python Scenerio0.py
```

Script Logic:

1. init batfish
2. check undefined References
3. check unused Structures

#### Scenerio 1, Configuration Change: COST

In this scenario, we want to service core1 and thus want to shift traffic to core2. We'll implement a change to cost out core1, and verify that it does not affect end-to-end reachability.

the configuration change manually in the batfish_snapshot/forwarding-change-validation/base, and use Scenerio1.py to check the result

Script Logic:

1. init batfish
2. check any traffic through core1 to hosts exists
3. check any traffic through core2 to hosts exists
4. check any success traffic to host-db exists
5. check any success traffic to host-www exists

#### Scenerio 2, Configuration Change: ACL

In this scenario, we have developed and tested a new web service on host host-www, and are now ready to open it to HTTP traffic from the outside world. The service is running on the hosts behind leaf1, which has an ACL in place that filters traffic to each host. The change we'll make and validate will open traffic to the host subnet in the border router ACLs that filter traffic entering the network.

the configuration change manually in the batfish_snapshot/forwarding-change-validation/base, and use Scenerio2.py to check the result

Script Logic:

1. init batfish
2. check any traffic through core1 to hosts exists
3. check any traffic through core2 to hosts exists
4. check any success traffic to host-db exists
5. check any success traffic to host-www exists